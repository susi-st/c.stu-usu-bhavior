<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å­¸ç”Ÿè©•é‡è¾¨è­˜ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // 1. å…§å»º SVG åœ–ç¤º (è§£æ±ºæ¸²æŸ“è¡çªå•é¡Œ)
        const Icons = {
            Upload: () => <svg className="w-12 h-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
            Loader: () => <svg className="animate-spin w-10 h-10 text-blue-600" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7" /></svg>,
            Save: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>,
            Robot: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
            Prev: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7" /></svg>,
            Next: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7" /></svg>
        };

        const { useState, useEffect } = React;

        // --- è¨­å®šå€ ---
        // è«‹å¡«å…¥æ‚¨çš„ Gemini API Key
        const GEMINI_API_KEY = "AIzaSyDJnm88dmiAOKW8_5mDbl6pgqmPFekkVN8"; 
        // è«‹å¡«å…¥æ‚¨çš„ Google Apps Script Web App URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyHfFgeTDsyAgujt7KIrTbII7r0Oa190Dh8KJe4qh38EMxpYvd3JjxblDFPPj4109Mz/exec"; 

        const LEVELS = ["å®Œå…¨ç¬¦åˆ", "éƒ¨åˆ†ç¬¦åˆ", "å¾…æ”¹é€²"];

        function App() {
            const [images, setImages] = useState([]);
            const [dataList, setDataList] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [processing, setProcessing] = useState(false);
            const [statusText, setStatusText] = useState("");

            // è™•ç†æª”æ¡ˆé¸æ“‡
            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const newImages = files.map(file => ({
                    file,
                    preview: URL.createObjectURL(file),
                    id: Math.random().toString(36).substr(2, 9)
                }));
                setImages(newImages);
            };

            // å•Ÿå‹• AI è¾¨è­˜
            const startAnalysis = async () => {
                if (!GEMINI_API_KEY) { alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ Gemini API Key"); return; }
                
                setProcessing(true);
                const results = [];

                for (let i = 0; i < images.length; i++) {
                    setStatusText(`æ­£åœ¨åˆ†æç¬¬ ${i + 1} / ${images.length} å¼µå½±åƒ...`);
                    
                    try {
                        // 1. è½‰ Base64
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(images[i].file);
                        });

                        // 2. å‘¼å« Gemini API
                        const prompt = `è«‹è¾¨è­˜é€™å¼µè©•é‡è¡¨åœ–ç‰‡ã€‚
                        è«‹æ“·å–ï¼š
                        1. åº§è™Ÿ (seatNumber) - ç´”æ•¸å­—
                        2. å§“å (name)
                        3. è©•é‡é …ç›®åˆ—è¡¨ (assessments) - æ¯å€‹é …ç›®åŒ…å« item(é …ç›®åç¨±) å’Œ level(ç­‰ç´šï¼šå®Œå…¨ç¬¦åˆ/éƒ¨åˆ†ç¬¦åˆ/å¾…æ”¹é€²)
                        
                        è«‹ç›´æ¥å›å‚³ç´” JSON æ ¼å¼ï¼Œä¸è¦ markdown æ¨™è¨˜ã€‚æ ¼å¼ç¯„ä¾‹ï¼š
                        {
                            "seatNumber": "5",
                            "name": "ç‹å°æ˜",
                            "assessments": [
                                { "item": "èƒ½ç†è§£äºŒé€²ä½", "level": "å®Œå…¨ç¬¦åˆ" }
                            ]
                        }`;

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        { inlineData: { mimeType: "image/jpeg", data: base64 } }
                                    ]
                                }]
                            })
                        });

                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                        
                        // 3. å¼·å¥çš„ JSON è§£æ
                        const jsonStr = text.replace(/```json|```/g, "").trim();
                        // å˜—è©¦æŠ“å–ç¬¬ä¸€å€‹ { å’Œæœ€å¾Œä¸€å€‹ } ä¹‹é–“çš„å…§å®¹ï¼Œé¿å… AI å»¢è©±
                        const cleanJsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                        const cleanJson = cleanJsonMatch ? cleanJsonMatch[0] : "{}";
                        
                        const parsedData = JSON.parse(cleanJson);

                        results.push({
                            ...parsedData,
                            preview: images[i].preview,
                            comment: "",
                            isSaved: false
                        });

                    } catch (error) {
                        console.error("Analysis Error:", error);
                        results.push({
                            seatNumber: "?", name: "è¾¨è­˜å¤±æ•—", assessments: [], preview: images[i].preview, isSaved: false
                        });
                    }
                }

                // ä¾åº§è™Ÿæ’åº
                results.sort((a, b) => (parseInt(a.seatNumber) || 999) - (parseInt(b.seatNumber) || 999));
                
                setDataList(results);
                setImages([]); // æ¸…ç©ºå¾…è™•ç†åœ–ç‰‡
                setProcessing(false);
            };

            // ç”Ÿæˆè©•èª
            const generateAiComment = async () => {
                const current = dataList[currentIndex];
                setProcessing(true);
                setStatusText("AI è€å¸«æ­£åœ¨æ’°å¯«è©•èª...");
                
                try {
                    const prompt = `ä½ æ˜¯ä¸€ä½æº«æš–çš„åœ‹ä¸­è€å¸«ã€‚è«‹æ ¹æ“šé€™ä½å­¸ç”Ÿçš„è©•é‡çµæœï¼š${JSON.stringify(current.assessments)}ï¼Œ
                    å¯«ä¸€æ®µç´„ 50 å­—çš„çŸ­è©•ï¼Œèªæ°£è¦æ­£å‘é¼“å‹µï¼Œé‡å°è¡¨ç¾å¥½çš„åœ°æ–¹ç¨±è®šï¼Œå¾…æ”¹é€²çš„åœ°æ–¹çµ¦äºˆæº«æŸ”å»ºè­°ã€‚`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    const data = await response.json();
                    const comment = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    
                    const newList = [...dataList];
                    newList[currentIndex].comment = comment;
                    setDataList(newList);

                } catch (e) {
                    alert("è©•èªç”Ÿæˆå¤±æ•—");
                }
                setProcessing(false);
            };

            // ä¸Šå‚³è‡³ Google Sheets
            const uploadToCloud = async () => {
                if (!GAS_URL) { alert("è«‹è¨­å®š GAS URL"); return; }
                
                setProcessing(true);
                setStatusText("æ­£åœ¨åŒæ­¥è‡³ Google è©¦ç®—è¡¨...");
                
                const current = dataList[currentIndex];
                
                try {
                    // é—œéµï¼šä½¿ç”¨ no-cors æ¨¡å¼
                    await fetch(GAS_URL, {
                        method: "POST",
                        mode: "no-cors", 
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(current)
                    });

                    // å› ç‚º no-cors æ”¶ä¸åˆ°å›æ‡‰ï¼Œæˆ‘å€‘å‡è¨­å®ƒæˆåŠŸ
                    const newList = [...dataList];
                    newList[currentIndex].isSaved = true;
                    setDataList(newList);
                    
                    // è‡ªå‹•è·³ä¸‹ä¸€ä½
                    setTimeout(() => {
                        if (currentIndex < dataList.length - 1) setCurrentIndex(c => c + 1);
                    }, 500);

                } catch (e) {
                    alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                }
                setProcessing(false);
            };

            // å°šæœªé–‹å§‹åˆ†æçš„ç•«é¢
            if (dataList.length === 0) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6">
                        <div className="bg-white p-10 rounded-3xl shadow-xl max-w-2xl w-full text-center border border-slate-200 fade-in">
                            <h1 className="text-3xl font-bold text-slate-800 mb-2">ğŸ“¸ AI å­¸ç”Ÿè©•é‡è¾¨è­˜ç³»çµ±</h1>
                            <p className="text-slate-500 mb-8">æ‹ç…§ -> AI è¾¨è­˜ -> è‡ªå‹•å­˜å…¥è©¦ç®—è¡¨</p>
                            
                            <label className="block p-12 border-2 border-dashed border-slate-300 rounded-2xl cursor-pointer hover:bg-slate-50 hover:border-blue-400 transition-all mb-8">
                                <input type="file" multiple accept="image/*" onChange={handleFileSelect} className="hidden" />
                                <div className="flex flex-col items-center">
                                    <Icons.Upload />
                                    <span className="mt-4 text-lg font-medium text-slate-600">
                                        {images.length > 0 ? `å·²é¸æ“‡ ${images.length} å¼µåœ–ç‰‡` : "é»æ“Šé¸æ“‡è©•é‡å–®ç…§ç‰‡ (å¯å¤šé¸)"}
                                    </span>
                                </div>
                            </label>

                            {images.length > 0 && (
                                <button 
                                    onClick={startAnalysis} 
                                    disabled={processing}
                                    className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-blue-700 transition-all shadow-lg disabled:bg-slate-400 flex items-center justify-center gap-2"
                                >
                                    {processing ? <><Icons.Loader /> {statusText}</> : "ğŸš€ é–‹å§‹æ‰¹æ¬¡è¾¨è­˜"}
                                </button>
                            )}
                        </div>
                    </div>
                );
            }

            const current = dataList[currentIndex];

            // çµæœæ ¸å°ç•«é¢
            return (
                <div className="min-h-screen p-4 md:p-8 max-w-7xl mx-auto fade-in">
                    {/* é®ç½© */}
                    {processing && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-2xl flex flex-col items-center shadow-2xl">
                                <Icons.Loader />
                                <p className="mt-4 font-bold text-slate-700">{statusText}</p>
                            </div>
                        </div>
                    )}

                    {/* é ‚éƒ¨å°è¦½ */}
                    <div className="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <h2 className="text-xl font-bold text-slate-700 flex items-center gap-2">
                            å­¸ç”Ÿï¼š{current.seatNumber} è™Ÿ - {current.name}
                            {current.isSaved && <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">å·²å­˜æª”</span>}
                        </h2>
                        <div className="flex gap-2">
                            <button onClick={() => setCurrentIndex(c => Math.max(0, c - 1))} disabled={currentIndex === 0} className="p-2 hover:bg-slate-100 rounded-lg disabled:opacity-30"><Icons.Prev /></button>
                            <span className="font-mono self-center px-2">{currentIndex + 1} / {dataList.length}</span>
                            <button onClick={() => setCurrentIndex(c => Math.min(dataList.length - 1, c + 1))} disabled={currentIndex === dataList.length - 1} className="p-2 hover:bg-slate-100 rounded-lg disabled:opacity-30"><Icons.Next /></button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[calc(100vh-140px)]">
                        {/* å·¦å´ï¼šåœ–ç‰‡é è¦½ */}
                        <div className="bg-slate-900 rounded-3xl overflow-hidden flex items-center justify-center relative shadow-lg">
                            <img src={current.preview} className="max-w-full max-h-full object-contain" />
                        </div>

                        {/* å³å´ï¼šè³‡æ–™ç·¨è¼¯ */}
                        <div className="bg-white rounded-3xl shadow-xl border border-slate-100 flex flex-col overflow-hidden">
                            <div className="p-8 overflow-y-auto flex-1 custom-scrollbar">
                                {/* åŸºæœ¬è³‡æ–™ */}
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase">åº§è™Ÿ</label>
                                        <input 
                                            value={current.seatNumber} 
                                            onChange={e => {
                                                const n = [...dataList]; n[currentIndex].seatNumber = e.target.value; n[currentIndex].isSaved = false; setDataList(n);
                                            }}
                                            className="w-full text-2xl font-bold border-b-2 border-slate-200 focus:border-blue-500 outline-none py-1" 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase">å§“å</label>
                                        <input 
                                            value={current.name} 
                                            onChange={e => {
                                                const n = [...dataList]; n[currentIndex].name = e.target.value; n[currentIndex].isSaved = false; setDataList(n);
                                            }}
                                            className="w-full text-2xl font-bold border-b-2 border-slate-200 focus:border-blue-500 outline-none py-1" 
                                        />
                                    </div>
                                </div>

                                {/* è©•é‡é …ç›® */}
                                <div className="space-y-4 mb-8">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">è©•é‡æŒ‡æ¨™æ ¸å°</h3>
                                    {current.assessments?.map((item, idx) => (
                                        <div key={idx} className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                            <p className="font-bold text-slate-700 mb-2">{item.item}</p>
                                            <div className="flex gap-2">
                                                {LEVELS.map(lvl => (
                                                    <button 
                                                        key={lvl}
                                                        onClick={() => {
                                                            const n = [...dataList];
                                                            n[currentIndex].assessments[idx].level = lvl;
                                                            n[currentIndex].isSaved = false;
                                                            setDataList(n);
                                                        }}
                                                        className={`px-3 py-1 rounded-lg text-sm font-bold transition-all ${
                                                            item.level === lvl 
                                                            ? 'bg-blue-600 text-white shadow-md scale-105' 
                                                            : 'bg-white text-slate-400 border border-slate-200 hover:bg-slate-100'
                                                        }`}
                                                    >
                                                        {lvl}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* è©•èªå€ */}
                                <div className="mb-4">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="text-xs font-bold text-slate-400 uppercase">æ•™å¸«è©•èª</label>
                                        <button onClick={generateAiComment} className="text-xs flex items-center gap-1 text-blue-600 font-bold bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100">
                                            <Icons.Robot /> AI è‡ªå‹•ç”Ÿæˆ
                                        </button>
                                    </div>
                                    <textarea 
                                        value={current.comment}
                                        onChange={e => {
                                            const n = [...dataList]; n[currentIndex].comment = e.target.value; n[currentIndex].isSaved = false; setDataList(n);
                                        }}
                                        className="w-full h-32 p-4 bg-slate-50 rounded-xl border border-slate-200 focus:border-blue-500 outline-none resize-none text-slate-700"
                                        placeholder="é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç”Ÿæˆè©•èªï¼Œæˆ–æ‰‹å‹•è¼¸å…¥..."
                                    ></textarea>
                                </div>
                            </div>

                            {/* åº•éƒ¨æ“ä½œåˆ— */}
                            <div className="p-6 border-t border-slate-100 bg-white">
                                <button 
                                    onClick={uploadToCloud}
                                    className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 transition-all ${
                                        current.isSaved 
                                        ? 'bg-green-500 text-white shadow-green-200' 
                                        : 'bg-slate-800 text-white hover:bg-blue-600 shadow-xl'
                                    }`}
                                >
                                    {current.isSaved ? <><Icons.Check /> è³‡æ–™å·²åŒæ­¥</> : <><Icons.Save /> ç¢ºèªä¸¦ä¸Šå‚³é›²ç«¯</>}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
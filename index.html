<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生評量管理系統 - 終極辨識版</title>
    <link rel="icon" href="data:,">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; overflow-x: hidden; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-card { animation: slideUp 0.4s ease-out forwards; }
        .btn-active-scale:active { transform: scale(0.95); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        const Icon = ({ name, size = 24, className = "" }) => {
            const paths = {
                'loader-2': <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
                'scan-face': <><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></>,
                'shield-alert': <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></>,
                'upload-cloud': <><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></>,
                'refresh-cw': <><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>,
                'chevron-left': <path d="m15 18-6-6 6-6" />,
                'chevron-right': <path d="m9 18 6-6-6-6" />,
                'hash': <><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></>,
                'user': <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                'sparkles': <><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></>,
                'check-circle': <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                'save': <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{paths[name] || null}</svg>;
        };

        const App = () => {
            const [images, setImages] = useState([]);
            const [dataList, setDataList] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [processing, setProcessing] = useState(false);
            const [loadingCloud, setLoadingCloud] = useState(false);
            const [cloudError, setCloudError] = useState(null);
            const [progress, setProgress] = useState({ current: 0, total: 0, task: "" });

            const gasUrl = "https://script.google.com/macros/s/AKfycbyHfFgeTDsyAgujt7KIrTbII7r0Oa190Dh8KJe4qh38EMxpYvd3JjxblDFPPj4109Mz/exec";
            const LEVELS = ["完全符合", "大部分符合", "部分符合", "待改進"];

            const indicatorThemes = [
                { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-700', active: 'bg-blue-600', ring: 'ring-blue-100', dot: 'bg-blue-400', hover: 'hover:bg-blue-100/50' },
                { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-700', active: 'bg-emerald-600', ring: 'ring-emerald-100', dot: 'bg-emerald-400', hover: 'hover:bg-emerald-100/50' },
                { bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-700', active: 'bg-amber-600', ring: 'ring-amber-100', dot: 'bg-amber-400', hover: 'hover:bg-amber-100/50' },
                { bg: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-700', active: 'bg-rose-600', ring: 'ring-rose-100', dot: 'bg-rose-400', hover: 'hover:bg-rose-100/50' },
                { bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-700', active: 'bg-indigo-600', ring: 'ring-indigo-100', dot: 'bg-indigo-400', hover: 'hover:bg-indigo-100/50' },
                { bg: 'bg-violet-50', border: 'border-violet-200', text: 'text-violet-700', active: 'bg-violet-600', ring: 'ring-violet-100', dot: 'bg-violet-400', hover: 'hover:bg-violet-100/50' },
                { bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-700', active: 'bg-cyan-600', ring: 'ring-cyan-100', dot: 'bg-cyan-400', hover: 'hover:bg-cyan-100/50' },
            ];

            const fetchCloudData = useCallback(async () => {
                setLoadingCloud(true);
                setCloudError(null);
                try {
                    const response = await fetch(gasUrl, { method: 'GET', redirect: 'follow' });
                    const cloudData = await response.json();
                    if (Array.isArray(cloudData)) {
                        const sorted = cloudData.map(item => ({ ...item, isSaved: true })).sort((a, b) => (parseInt(a.seatNumber) || 0) - (parseInt(b.seatNumber) || 0));
                        setDataList(sorted);
                    }
                } catch (e) {
                    setCloudError("雲端載入受限。請確認 GAS 已部署為「所有人」。");
                } finally {
                    setLoadingCloud(false);
                }
            }, [gasUrl]);

            useEffect(() => { fetchCloudData(); }, [fetchCloudData]);

            const handleFileUpload = (e) => {
                const files = Array.from(e.target.files);
                const newImages = files.map(file => ({ file, id: Math.random().toString(36).substr(2, 9), preview: URL.createObjectURL(file) }));
                setImages(prev => [...prev, ...newImages]);
            };

            const startRecognition = async () => {
                if (images.length === 0) return;
                setProcessing(true);
                const currentResults = [...dataList];
                setProgress({ current: 0, total: images.length, task: "啟動安全代理辨識..." });

                for (let i = 0; i < images.length; i++) {
                    setProgress(p => ({ ...p, current: i + 1, task: `分析第 ${i+1} 份評量...` }));
                    try {
                        const base64 = await new Promise((res) => {
                            const r = new FileReader(); r.readAsDataURL(images[i].file);
                            r.onload = () => res(r.result.split(',')[1]);
                        });

                        // 關鍵：將內容轉為字串並使用 text/plain 繞過 CORS
                        const resp = await fetch(gasUrl, {
                            method: 'POST',
                            redirect: 'follow', 
                            headers: { 'Content-Type': 'text/plain' },
                            body: JSON.stringify({ action: "ocr", base64: base64 })
                        });
                        
                        const data = await resp.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        const result = JSON.parse(resultText);
                        
                        const entry = { ...result, seatNumber: String(result.seatNumber || ""), name: String(result.name || "未識別"), preview: `data:image/jpeg;base64,${base64}`, comment: "", isSaved: false };
                        const idx = currentResults.findIndex(item => String(item.seatNumber) === String(result.seatNumber));
                        if (idx > -1) currentResults[idx] = entry; else currentResults.push(entry);
                    } catch (e) { 
                        console.error("辨識異常:", e); 
                        setProgress(p => ({ ...p, task: `連線失敗，請檢查 GAS 權限。` }));
                        await new Promise(r => setTimeout(r, 2000));
                        break;
                    }
                }
                setDataList(currentResults.sort((a, b) => (parseInt(a.seatNumber) || 0) - (parseInt(b.seatNumber) || 0)));
                setProcessing(false);
                setCurrentIndex(0);
                setImages([]);
            };

            const saveToSheet = async (index) => {
                if (!dataList[index]) return;
                setProcessing(true);
                setProgress({ current: 1, total: 1, task: "同步雲端中..." });
                try {
                    await fetch(gasUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ ...dataList[index], action: "save" }) 
                    });
                    const newList = [...dataList];
                    newList[index].isSaved = true;
                    setDataList(newList);
                } catch (e) { alert("同步失敗"); }
                setProcessing(false);
            };

            const currentStudent = useMemo(() => (dataList && dataList.length > 0) ? dataList[currentIndex] : null, [dataList, currentIndex]);

            const groupedAssessments = useMemo(() => {
                if (!currentStudent || !currentStudent.assessments) return [];
                const groups = [];
                const map = new Map();
                currentStudent.assessments.forEach((item, originalIdx) => {
                    const parts = item.item.split(/[-－:：]/);
                    const category = parts.length > 1 ? parts[0].trim() : "指標細項";
                    const subItem = parts.length > 1 ? parts.slice(1).join('-').trim() : item.item.trim();
                    if (!map.has(category)) {
                        const theme = indicatorThemes[groups.length % indicatorThemes.length];
                        const newGroup = { category, items: [], theme };
                        map.set(category, newGroup);
                        groups.push(newGroup);
                    }
                    map.get(category).items.push({ ...item, displayName: subItem, originalIdx });
                });
                return groups;
            }, [currentStudent]);

            const updateAssessment = (originalIdx, level) => {
                setDataList(prev => {
                    const newList = [...prev];
                    const student = { ...newList[currentIndex] };
                    const assessments = [...student.assessments];
                    assessments[originalIdx] = { ...assessments[originalIdx], level: level };
                    student.assessments = assessments;
                    student.isSaved = false;
                    newList[currentIndex] = student;
                    return newList;
                });
            };

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center">
                    {processing && (
                        <div className="fixed inset-0 bg-slate-900/40 backdrop-blur-md z-[60] flex items-center justify-center p-6 text-white text-center">
                            <div className="bg-slate-800 rounded-[3rem] p-12 w-full max-w-md shadow-2xl border border-white/10 animate-in">
                                <Icon name="loader-2" size={64} className="animate-spin text-blue-400 mb-4 mx-auto" />
                                <h3 className="text-2xl font-black mb-4 tracking-tighter">{progress.task}</h3>
                                <div className="w-full bg-slate-700 rounded-full h-1.5 mb-3 overflow-hidden">
                                    <div className="bg-blue-500 h-full transition-all duration-500" style={{ width: `${(progress.total > 0 ? (progress.current / progress.total) * 100 : 0)}%` }}></div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="w-full max-w-7xl">
                        {dataList.length === 0 && !loadingCloud ? (
                            <div className="bg-white p-12 rounded-[4rem] shadow-2xl text-center border border-slate-100 animate-card">
                                <div className="w-24 h-24 bg-blue-50 text-blue-600 rounded-[2.5rem] flex items-center justify-center mx-auto mb-8 shadow-inner"><Icon name="scan-face" size={48} /></div>
                                <h1 className="text-5xl font-black mb-6 tracking-tighter text-slate-800">學生評量管理系統</h1>
                                <p className="text-slate-500 mb-12 text-xl font-medium max-w-3xl mx-auto leading-relaxed">已升級安全性連線。API Key 已受後端保護，可在 GitHub Pages 穩定執行。</p>
                                {cloudError && <div className="mb-10 p-6 bg-rose-50 text-rose-700 rounded-[2rem] text-sm border border-rose-100 flex items-start gap-4 text-left max-w-2xl mx-auto shadow-sm"><Icon name="shield-alert" size={24} className="flex-shrink-0 mt-1" /><p className="font-medium text-balance">{String(cloudError)}</p></div>}
                                <input type="file" multiple accept="image/*" onChange={handleFileUpload} className="hidden" id="file-upload" />
                                <label htmlFor="file-upload" className="block p-20 border-4 border-dashed border-slate-100 rounded-[4rem] cursor-pointer hover:bg-blue-50 transition-all duration-500 group"><Icon name="upload-cloud" size={72} className="mx-auto text-slate-300 mb-6 group-hover:-translate-y-3 transition-transform" /><p className="text-3xl font-black text-slate-700 tracking-tight">{images.length > 0 ? `已選取 ${images.length} 份文件` : "點擊此處匯入評量照片"}</p></label>
                                <div className="mt-16 flex flex-wrap justify-center gap-8"><button onClick={startRecognition} disabled={images.length===0} className="px-20 py-8 bg-blue-600 text-white rounded-[2.5rem] font-black text-3xl shadow-2xl disabled:bg-slate-200 transition-all hover:scale-105 active:scale-95">啟動 AI 辨識</button><button onClick={fetchCloudData} className="px-12 py-8 bg-white border-2 border-slate-100 rounded-[2.5rem] font-bold text-slate-600 text-xl flex items-center gap-3 hover:bg-slate-50 shadow-lg"><Icon name="refresh-cw" size={28} /> 讀取存檔</button></div>
                            </div>
                        ) : (
                            currentStudent && (
                                <div className="space-y-6 animate-card">
                                    <div className="bg-white/90 backdrop-blur-2xl px-10 py-5 rounded-[3rem] shadow-sm flex items-center justify-between border border-slate-100 sticky top-4 z-40">
                                        <div className="flex items-center gap-8"><div className="bg-slate-900 text-white px-6 py-3 rounded-2xl font-mono font-black text-2xl shadow-xl">{currentIndex + 1} / {dataList.length}</div><h2 className="font-black text-slate-800 text-3xl tracking-tighter text-balance">座號 <span className="text-blue-600">{String(currentStudent.seatNumber)}</span> — {String(currentStudent.name)}</h2></div>
                                        <div className="flex gap-4"><button onClick={() => setCurrentIndex(p => Math.max(p - 1, 0))} disabled={currentIndex===0} className="p-5 bg-white border border-slate-100 rounded-2xl hover:bg-slate-50 active:scale-90 shadow-sm disabled:opacity-30 transition-all"><Icon name="chevron-left" size={28} /></button><button onClick={() => setCurrentIndex(p => Math.min(p + 1, dataList.length - 1))} disabled={currentIndex===dataList.length-1} className="p-5 bg-white border border-slate-100 rounded-2xl hover:bg-slate-50 active:scale-90 shadow-sm disabled:opacity-30 transition-all"><Icon name="chevron-right" size={28} /></button></div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start pb-10">
                                        <div className="bg-white p-6 rounded-[3.5rem] shadow-2xl border border-slate-50 group sticky top-36"><div className="bg-slate-100/30 rounded-[2.5rem] overflow-hidden md:min-h-[800px] flex items-center justify-center border border-slate-100 relative group-hover:shadow-inner transition-shadow">{currentStudent.preview ? <img src={currentStudent.preview} className="max-w-full max-h-full object-contain transition-transform duration-1000 group-hover:scale-110" /> : <p className="font-black text-slate-400 italic text-2xl text-center px-10">影像資料解析中...</p>}</div></div>
                                        <div className="space-y-6">
                                            <div className="bg-white p-8 rounded-[3.5rem] shadow-2xl border border-slate-100 grid grid-cols-2 gap-8">
                                                <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest font-mono">SEAT NO.</label><input type="number" value={String(currentStudent.seatNumber || "")} onChange={e => {const nl=[...dataList];nl[currentIndex]={...nl[currentIndex],seatNumber:e.target.value,isSaved:false};setDataList(nl);}} className="w-full text-4xl font-black border-b-4 border-slate-50 focus:border-blue-500 outline-none pb-2 bg-transparent transition-all" /></div>
                                                <div className="space-y-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest font-mono">NAME</label><input type="text" value={String(currentStudent.name || "")} onChange={e => {const nl=[...dataList];nl[currentIndex]={...nl[currentIndex],name:e.target.value,isSaved:false};setDataList(nl);}} className="w-full text-4xl font-black border-b-4 border-slate-50 focus:border-blue-500 outline-none pb-2 bg-transparent transition-all" /></div>
                                            </div>
                                            <div className="space-y-4">
                                                {groupedAssessments.map((group, gIdx) => (
                                                    <div key={gIdx} className={`rounded-[3rem] border-2 ${group.theme.border} ${group.theme.bg} shadow-md relative overflow-hidden transition-all hover:shadow-xl`}>
                                                        <div className={`absolute top-0 left-0 w-2 h-full ${group.theme.active}`}></div>
                                                        <div className="px-6 py-4">
                                                            <div className="flex items-center gap-3 mb-4"><div className={`w-3 h-3 rounded-full ${group.theme.dot} animate-pulse`}></div><h3 className={`text-xl font-black ${group.theme.text} tracking-tight`}>{group.category}</h3></div>
                                                            <div className="space-y-0.5">
                                                                {group.items.map((item, iIdx) => (
                                                                    <div key={iIdx} className={`flex flex-col xl:flex-row xl:items-center justify-between gap-3 py-1.5 px-3 rounded-2xl ${group.theme.hover} transition-200 border-b border-white/40 last:border-0`}>
                                                                        <span className="text-sm font-bold text-slate-700 leading-tight flex-1 mr-4">{item.displayName}</span>
                                                                        <div className="flex bg-white/40 p-0.5 rounded-xl border border-white/30 shadow-inner no-scrollbar overflow-x-auto">
                                                                            {LEVELS.map(l => (
                                                                                <button key={l} onClick={() => updateAssessment(item.originalIdx, l)} className={`px-3 py-1.5 text-[9px] sm:text-[10px] font-black rounded-lg transition-all duration-300 whitespace-nowrap btn-active-scale ${item.level === l ? `${group.theme.active} text-white shadow-md ring-2 ${group.theme.ring}` : `text-slate-400 hover:text-slate-500 bg-transparent`}`}>{String(l)}</button>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            <div className="bg-white p-10 rounded-[3.5rem] shadow-2xl border border-slate-100 flex flex-col gap-6"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 font-mono"><Icon name="sparkles" size={14} /> AI TEACHER FEEDBACK</label><textarea value={String(currentStudent.comment || "")} onChange={e => {const nl=[...dataList];nl[currentIndex]={...nl[currentIndex],comment:e.target.value,isSaved:false};setDataList(nl);}} className="w-full h-44 p-8 bg-blue-50/10 rounded-[2.5rem] focus:bg-white outline-none resize-none text-slate-700 text-lg italic leading-relaxed shadow-inner" /></div>
                                            <button onClick={() => saveToSheet(currentIndex)} className={`w-full py-7 rounded-[3rem] font-black text-2xl flex items-center justify-center gap-5 transition-all duration-500 shadow-2xl hover:-translate-y-1 active:scale-95 ${currentStudent.isSaved ? 'bg-emerald-500 text-white shadow-emerald-100 ring-4 ring-emerald-50' : 'bg-slate-900 text-white hover:bg-blue-600'}`}>{currentStudent.isSaved ? <><Icon name="check-circle" size={32} /> 資料同步成功</> : <><Icon name="save" size={32} /> 確認並存至雲端</>}</button>
                                        </div>
                                    </div>
                                </div>
                            )
                        )}
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>